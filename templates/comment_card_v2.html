<div class="comment-card {% if comment.is_replied %}replied-comment-card{% endif %}" id="comment-{{ comment.id }}">
    <div class="comment-header">
        <div class="comment-meta-left">
            <img src="{{ comment.author_image }}" alt="{{ comment.author_name }}" class="author-img">
            <span class="author-name">@{{ comment.author_name }}</span>
            <span class="date">{{ comment.published_at[:10] }}</span>
        </div>
        <div class="comment-meta-right" id="meta-{{ comment.id }}" data-rating="{{ comment.viewer_rating }}">
            <span class="like-count">ã„ã„ã­æ•° {{ comment.like_count }}</span>

            <!-- Like Button -->
            <button class="btn-icon like-btn {% if comment.viewer_rating == 'like' %}active{% endif %}"
                onclick="rateComment('{{ comment.id }}', 'like', this)" title="ã„ã„ã­">
                <span class="icon-emoji">ğŸ‘</span>
            </button>

            <!-- Dislike Button -->
            <button class="btn-icon dislike-btn {% if comment.viewer_rating == 'dislike' %}active{% endif %}"
                onclick="rateComment('{{ comment.id }}', 'dislike', this)" title="ä½è©•ä¾¡">
                <span class="icon-emoji">ğŸ‘</span>
            </button>

            <button class="btn-icon" onclick="deleteComment('{{ comment.id }}')" title="å‰Šé™¤">
                <span class="icon-emoji">ğŸ—‘ï¸</span>
            </button>
        </div>
    </div>
    <div class="comment-text">{{ comment.text }}</div>

    {% if comment.is_replied and comment.replies %}
    <!-- Reply Thread -->
    <div class="reply-thread" id="thread-{{ comment.id }}">
        {% for reply in comment.replies %}
        <div class="reply-item {% if reply.is_mine %}my-reply{% endif %}" id="comment-{{ reply.id }}">
            <img src="{{ reply.author_image }}" alt="{{ reply.author_name }}" class="reply-author-img">
            <div class="reply-content">
                <div class="reply-header">
                    <span class="reply-author-name">@{{ reply.author_name }}</span>
                    <span class="reply-date">{{ reply.published_at[:10] }}</span>
                    {% if reply.is_mine %}
                    <button class="btn-icon-small" onclick="deleteComment('{{ reply.id }}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    {% endif %}
                </div>
                <div class="reply-text">{{ reply.text }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="reply-section">
        <!-- Generate Button -->
        <div class="generate-btn-wrapper">
            <button class="btn-generate"
                onclick="generateReply('{{ comment.id }}', '{{ video_id }}', `{{ comment.text | replace('`', '\`') }}`)"
                id="btn-generate-{{ comment.id }}">âœ¨ è¿”ä¿¡æ¡ˆã‚’ç”Ÿæˆ</button>
            <button class="btn-regenerate"
                onclick="generateReply('{{ comment.id }}', '{{ video_id }}', `{{ comment.text | replace('`', '\`') }}`)"
                id="btn-regenerate-{{ comment.id }}" style="display: none;">ğŸ”„ å†ç”Ÿæˆ</button>
        </div>

        <!-- Suggestions Chips -->
        <div id="suggestions-{{ comment.id }}" class="suggestions-box" style="display: none;"></div>

        <!-- Manual Reply Area (Always Visible) -->
        <div class="reply-input-wrapper">
            <textarea id="reply-text-{{ comment.id }}" class="reply-input" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..."></textarea>

            <!-- Hidden fields to store context for logging -->
            <input type="hidden" id="original-comment-{{ comment.id }}" value="{{ comment.text }}">
            <input type="hidden" id="ai-suggestion-{{ comment.id }}" value="">
            <input type="hidden" id="custom-prompt-{{ comment.id }}" value="">

            <button id="btn-post-{{ comment.id }}" class="btn-post"
                onclick="postReply('{{ comment.id }}', {{ 'true' if comment.is_replied else 'false' }}, '{{ video_id }}')">è¿”ä¿¡</button>
        </div>
    </div>
</div>