{% extends "base.html" %}

{% block content %}
<div class="login-wrapper">
    <h1>Comment ã•ãã•ã Checker</h1>
    <p>ã‚³ãƒ¡ãƒ³ãƒˆè¿”ä¿¡ç‡100%ã§ã€YouTubeã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è©•ä¾¡ã‚’é«˜ã‚ã€ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚’é«˜ã‚ã‚‹AIãƒ„ãƒ¼ãƒ«ï¼</p>
    <!-- Replace link with button for JS handling -->
    <button id="login-btn" class="btn-login">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>

    {% if is_dev_mode %}
    <div style="margin-top: 20px;">
        <a href="{{ url_for('dev_login') }}" class="btn-login" style="background-color: #333; font-size: 0.9em;">ğŸ›  Dev
            Login (Mock Data)</a>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const supabaseUrl = '{{ supabase_url }}';
    const supabaseKey = '{{ supabase_key }}';

    console.log("Supabase URL Check:", supabaseUrl);
    // Don't log the key for security, just check existence
    console.log("Supabase Key Check:", supabaseKey ? "Present" : "Missing");

    if (!supabaseUrl || supabaseUrl === 'None' || !supabaseKey || supabaseKey === 'None') {
        alert("Configuration Error: Supabase URL or Key is missing in Render Environment Variables. Please check the console.");
        console.error("Supabase config missing. URL:", supabaseUrl, "Key:", supabaseKey);
    }

    let supabase;
    try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    } catch (e) {
        console.error("Failed to initialize Supabase client:", e);
        alert("Failed to initialize Supabase. See console.");
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
        const btn = document.getElementById('login-btn');
        btn.disabled = true;
        btn.innerText = 'Connecting...';

        if (!supabase) {
            alert("Supabase client not initialized.");
            btn.disabled = false;
            return;
        }

        try {
            console.log("Attempting sign in with Google...");
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: '{{ url_for("auth_callback", _external=True) }}',
                    scopes: 'https://www.googleapis.com/auth/youtube.force-ssl https://www.googleapis.com/auth/yt-analytics.readonly',
                    queryParams: {
                        access_type: 'offline',
                        prompt: 'consent'
                    }
                }
            });
            if (error) throw error;
            console.log("Sign in initiated:", data);
        } catch (e) {
            console.error("Login Error:", e);
            alert('Login failed: ' + e.message);
            btn.disabled = false;
            btn.innerText = 'Googleã§ãƒ­ã‚°ã‚¤ãƒ³';
        }
    });
</script>
{% endblock %}